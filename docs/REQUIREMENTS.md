# ライブラリ要件定義

## 1. ドキュメント情報
- ドキュメントID: OK-REQ-001
- バージョン: 0.2
- 最終更新日: 2025-09-27
- 対象システム: ownerkeeper リソース所有権管理ライブラリ (.NET 8)

## 2. 要件ID命名規則
- ID 形式: `REQ-<カテゴリ略号>-<3桁番号>`
- カテゴリ略号一覧:

| 略号 | カテゴリ |
| --- | --- |
| OV | 概要 |
| SN | 想定シナリオ |
| IN | 初期化・終了 |
| OW | 所有権・ライフサイクル |
| RC | リソース競合 |
| TH | スレッド安全性 |
| ST | 状態管理 |
| ER | 例外・エラー通知 |
| EC | エラーコード体系 |
| EV | イベントモデル |
| CT | キャンセル／タイムアウト |
| RM | リソース管理 |
| MM | メモリ管理 |
| CF | 設定・構成管理 |
| LG | ログ・診断 |
| MN | 監視・メトリクス |
| PF | 性能方針 |
| AI | APIインターフェイス管理 |
| TS | テスト・モック戦略 |
| VR | バージョニング・互換性 |
| SE | セキュリティ |
| IM | 実装制約 |
| FU | 将来拡張 |

## 3. 要件一覧

### 3.1 概要 (OV)
- [REQ-OV-001] 同期APIを通じて非同期処理を開始し、リソース所有権を厳密に管理する。
- [REQ-OV-002] 処理結果や状態をデリゲートイベントで通知し、クライアントコードがスレッドセーフに受信できるようにする。
- [REQ-OV-003] カメラ以外のハードウェアにも拡張可能なアーキテクチャを採用する。

### 3.2 想定シナリオ (SN)
- [REQ-SN-001] API呼び出しでカメラ操作（例: ストリーミング開始）をトリガーできること。
- [REQ-SN-002] 同期API呼び出しは制御を即時に呼び出し元へ返却し、完了可否・結果はイベントで判断できること。
- [REQ-SN-003] 非同期処理の進行・結果・状態を `MyNotificationHub` に類似したデリゲートイベントで通知すること。

### 3.3 初期化・終了 (IN)
- [REQ-IN-001] ライブラリ全体の初期化APIを提供し、リソーステーブルやログ設定などのグローバル状態を準備する。
- [REQ-IN-002] 終了API（例: `Shutdown`）でグローバルリソースを解放し、未解放インターフェイスの所有権を未設定に戻す。
- [REQ-IN-003] 初期化前にAPIインターフェイスを払い出そうとした場合は例外で通知する。
- [REQ-IN-004] 初期化および終了処理の多重呼び出しを防止／冪等化し、必要に応じてシングルトンパターンで中枢コンポーネントを管理する。
- [REQ-IN-005] 予期しない終了に備え、主要コンポーネントにファイナライザや `Dispose` パターンを実装して所有権を最終的に解放する。

### 3.4 所有権・ライフサイクル (OW)
- [REQ-OW-001] リソースは単独所有とし、APIインターフェイス単位で所有権を割り当てる。
- [REQ-OW-002] 所有権を保有するインターフェイスのみがリソース停止・解放などの操作を実行できる。
- [REQ-OW-003] 非同期処理中はリソースをロックし、失敗時にはロックを解放してイベントでエラーを通知する。
- [REQ-OW-004] APIインターフェイスの `Dispose` 呼び出し時に所有権を未設定へ戻し、`Dispose` が呼ばれない場合でも最終的に解放される仕組みを提供する。

### 3.5 リソース競合 (RC)
- [REQ-RC-001] 同一リソースに対する複数インターフェイスの要求が競合した場合、先に所有権を取得したインターフェイスを優先し、後続要求には即時エラーコードを返却する。
- [REQ-RC-002] 競合発生時はイベントでエラーコードを通知し、Loggerにも記録する。

### 3.6 スレッド安全性 (TH)
- [REQ-TH-001] 所有権チェック、ロック制御、イベント発火などすべての公開APIをスレッドセーフに実装する。

### 3.7 状態管理 (ST)
- [REQ-ST-001] 状態は `CameraState { Uninitialized, Initializing, Ready, Streaming, Paused, Stopped, Error }` を基準とする。
- [REQ-ST-002] 状態遷移は許可されたルールに従い、不正な遷移要求は誤用の場合は例外、運用時要因の場合はイベントエラーとして扱う。
- [REQ-ST-003] 各状態で許可される操作を定義し、次の制約を遵守する。
  - `Ready`: ストリーム開始や設定変更を許可する。
  - `Streaming`: 停止・一時停止・状態取得を許可し、所有権を持つインターフェイスからの設定変更要求はドライバ仕様に従って処理する。
  - `Paused`: 再開・停止のみ許可する。
  - `Stopped`: 再初期化せずに `Ready` へ戻る準備操作を許可する。
  - `Error`: リカバリまたは再初期化に限定する。
- [REQ-ST-004] 状態遷移は表 ST-1（付録）に準拠し、表に記載のない遷移は許可しない。

### 3.8 例外・エラー通知 (ER)
- [REQ-ER-001] 明白な誤用（パラメータ不正、初期化漏れ、未対応API呼び出し等）は例外で通知し、開発時に修正できるようにする。
- [REQ-ER-002] 運用中に発生し得るランタイムエラー（所有権競合、ハードウェア不調、実行中の失敗等）はイベントでエラーコードを通知し、例外は投げない。
- [REQ-ER-003] 非同期処理中の失敗は全てイベント通知とし、呼び出し側はイベントを通じて完了可否を判断する。

### 3.9 エラーコード体系 (EC)
- [REQ-EC-001] エラーコードはカテゴリ（SYS/HW/OWN/ARG 等）ごとにプレフィックスまたは数値範囲を定める。
- [REQ-EC-002] コード範囲は `SYS0001–SYS0999`、`HW1000–HW1999`、`OWN2000–OWN2999`、`ARG3000–ARG3999` を基準として拡張する。
- [REQ-EC-003] 代表的なエラーコードと対処方針は表 ERR-1（付録）に示し、必要に応じてカメラ固有コードを追加定義する。
- [REQ-EC-004] エラー状態からのリカバリ手段として `Reset` API など再初期化のパスを提供する。

### 3.10 イベントモデル (EV)
- [REQ-EV-001] 各APIと同名のデリゲートイベントを公開し、イベント引数で成功/失敗の判定ができる情報を提供する。
- [REQ-EV-002] 成功イベントでは `CameraState` と解像度・ピクセルフォーマット・フレームレート等のメタデータを通知する。
- [REQ-EV-003] 失敗イベントではエラーコードのみを通知し、例外情報は含めない。
- [REQ-EV-004] イベントハンドラはスレッドプール上で実行する。

### 3.11 キャンセル・タイムアウト (CT)
- [REQ-CT-001] APIインターフェイス払い出し時に任意で `CancellationToken` を登録でき、ストリーム開始/停止/設定変更など長時間操作にキャンセル要求を反映する。
- [REQ-CT-002] タイムアウトは各API内部で固定または構成値を持ち、利用者には直接露出させない。

### 3.12 リソース管理 (RM)
- [REQ-RM-001] ライブラリ内部でリソーステーブルを保持し、自動採番されたハードウェアIDと所有権ハンドルを紐付けて管理する。
- [REQ-RM-002] カメラ実体は初期段階ではスタブで扱い、将来的に実機と差し替えられる抽象化層を用意する。

### 3.13 メモリ管理 (MM)
- [REQ-MM-001] 画像データなど大容量バッファは `ArrayPool<byte>` 等のプール機構で再利用する。
- [REQ-MM-002] バッファの確保・解放は所有権に紐付け、`Dispose` 時に確実に返却する。
- [REQ-MM-003] 非管理リソースは `IDisposable`/`IAsyncDisposable` を徹底し、メモリリークを防止する。

### 3.14 設定・構成管理 (CF)
- [REQ-CF-001] 解像度・フレームレート・ピクセルフォーマットなどリソース設定を動的に変更できるAPIを提供する。
- [REQ-CF-002] 設定変更は所有権を持つインターフェイスのみ実行できる。
- [REQ-CF-003] 所有権を持つインターフェイスからの要求であれば `Streaming` 中でもドライバ仕様に従って設定変更を試行し、結果（成功・失敗）をイベントで通知する。
- [REQ-CF-004] 設定のデフォルト値はライブラリ内に保持し、永続化は現段階では行わない（将来的に設定ストア連携を検討）。

### 3.15 ログ・診断 (LG)
- [REQ-LG-001] `Console.WriteLine` をラップした Logger クラスを提供し、API要求受付・デリゲート通知・エラー発生時にログを記録する。
- [REQ-LG-002] ログレベル（Info/Warning/Error）の切り替えをサポートし、将来的な外部ログ基盤との連携を見据える。

### 3.16 監視・メトリクス (MN)
- [REQ-MN-001] API呼び出し回数、平均処理時間、エラー率など基本メトリクスを収集する仕組みを提供する。
- [REQ-MN-002] リソーステーブルやエラーカウンタを確認できるヘルスチェックAPIを提供する。
- [REQ-MN-003] 詳細ログを有効化するデバッグモードを提供する。

### 3.17 性能方針 (PF)
- [REQ-PF-001] 特定の数値目標は設けず、ベストエフォートで低遅延・高スループットを目指す。
- [REQ-PF-002] 収集したメトリクスを用いてボトルネック分析と最適化が行えるようにする。

### 3.18 APIインターフェイス管理 (AI)
- [REQ-AI-001] 1ユーザにつき1つのAPIインターフェイスを払い出し、ユーザ識別子は指定文字列を優先し未指定時はUUIDを自動生成する。
- [REQ-AI-002] APIインターフェイスは `Dispose` を必須とし、破棄時に所有権を解放する。
- [REQ-AI-003] APIインターフェイス払い出し時に（必要であれば）`CancellationToken` などコンテキスト情報を登録できるようにする。

### 3.19 テスト・モック戦略 (TS)
- [REQ-TS-001] カメラスタブ実装を標準提供し、実機が無くてもAPI検証を可能にする。
- [REQ-TS-002] スタブと実機の切り替えを依存性注入または設定で行えるようにする。
- [REQ-TS-003] 成功・失敗・遅延などを再現できるモックカメラ仕様を整備し、単体/統合テストで利用する。

### 3.20 バージョニング・互換性 (VR)
- [REQ-VR-001] Semantic Versioning を採用し、APIバージョンを管理する。
- [REQ-VR-002] 重大な互換性破壊はメジャーバージョンアップ時にのみ実施する。
- [REQ-VR-003] 必要に応じて旧API向け互換レイヤーの提供を検討する。

### 3.21 セキュリティ (SE)
- [REQ-SE-001] APIインターフェイス払い出し時に識別子と所有権を紐付け、権限のないアクセスを防止する。
- [REQ-SE-002] 将来のネットワークカメラ対応を考慮し、イベントやデータ転送に暗号化/認証を適用できる拡張ポイントを確保する。
- [REQ-SE-003] ログには機密情報を出力せず、必要に応じてマスキングを行う。

### 3.22 実装制約 (IM)
- [REQ-IM-001] .NET 8 標準ライブラリのみを利用し、`IDisposable`/`IAsyncDisposable` を活用して所有権ハンドルを提供する。

### 3.23 将来拡張 (FU)
- [REQ-FU-001] カメラ以外のハードウェアにも対応できるよう、リソーステーブルやイベントモデルを抽象化する。
- [REQ-FU-002] メトリクス、セキュリティ、設定管理を外部システムと連携できる拡張ポイントを設ける。

## 4. 付録

### 表 ST-1 状態遷移テーブル（ドラフト）
| 現在状態 | トリガー操作/イベント | 遷移後状態 | 備考 |
| --- | --- | --- | --- |
| Uninitialized | `Initialize()` 呼び出し | Initializing | 初期化処理をバックグラウンドで開始 |
| Initializing | 初期化完了イベント | Ready | 初期化成功時にイベント通知 |
| Initializing | 初期化失敗イベント | Error | `SYS0001` などのエラーコードを通知 |
| Ready | `StartStreaming()` | Streaming | 成功時はストリーム開始イベントを通知 |
| Ready | 設定変更 | Ready | 状態維持。設定失敗時はエラーイベント |
| Ready | `Shutdown` / 所有権解放 | Uninitialized | リソース解放後に初期状態へ戻る |
| Streaming | `Pause()` | Paused | ストリーム一時停止 |
| Streaming | `Stop()` | Stopped | 停止完了イベントを通知 |
| Streaming | 設定変更 | Streaming | ドライバが許容する場合のみ継続、失敗時はエラーイベント |
| Streaming | ハードウェアエラー発生 | Error | `HW` カテゴリのエラーコードを通知 |
| Paused | `Resume()` | Streaming | 再開イベントを通知 |
| Paused | `Stop()` | Stopped | 停止イベントを通知 |
| Stopped | `Prepare()` / 再初期化 | Ready | 内部クリーンアップ後に準備完了イベント |
| Error | `Reset()` | Ready | リカバリ成功時にエラー解除イベント |
| Error | `Shutdown` | Uninitialized | リソースを完全解放 |

> 表 ST-1 に記載されていない遷移要求は無効とし、誤用は例外、運用起因はイベントエラーで通知する。

### 表 ERR-1 代表的なエラーコード（ドラフト）
| コード例 | カテゴリ | 典型シナリオ | リカバリ指針 |
| --- | --- | --- | --- |
| `SYS0001` | システム | 初期化内部例外（設定ファイル破損など） | ログ確認後に再初期化またはアプリ再起動 |
| `SYS0002` | システム | 終了処理中のリソース解放失敗 | リトライ。解放不能時はプロセス終了を検討 |
| `HW1001` | ハードウェア | デバイス未検出 / 切断 | 接続確認後に再初期化 |
| `HW1002` | ハードウェア | ストリーミング中のデータ取得失敗 | 自動リトライ後に改善しなければ `Reset` |
| `OWN2001` | 所有権 | 他インターフェイスが所有権を保持 | 所有権解放を待ち再取得を試行 |
| `OWN2002` | 所有権 | 所有権ハンドルの期限切れ／Dispose漏れ | 新しいインターフェイスを取得し直す |
| `ARG3001` | 引数 | 無効な解像度やフォーマット指定 | パラメータを修正して再実行 |
| `ARG3002` | 引数 | 未初期化状態でのAPI呼び出し | 初期化API実行後に再試行 |

> 表 ERR-1 のコードはドラフトであり、実装時に詳細コードやハードウェア固有コードを拡張する。
